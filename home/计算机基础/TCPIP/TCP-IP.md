# `TCP/IP`

网络协议就是一套通用规则，用来帮助定义复杂数据传输的过程。

## `TCP/IP`协议

`TCP/IP`协议定义了网络通信过程,更重要的是,定义了数据单元的格式和内容,以便接收计算机能够正确解释接收到的消息

* `TCP/IP`标准定义了`TCP/IP`网络的通信规则；

* `TCP/IP`实现是一个软件组件，计算机通过它参与到`TCP/IP`网络中。

  `TCP/IP`标准的目的是确保所有厂商提供的`TCP/IP`实现都能够很好地兼容。



像TCP/IP这样的协议系统必须负责完成以下任务。
* 把消息分解为可管理的数据块，并且这些数据块能够有效地通过传输介质。
* 与网络适配器硬件连接。
* 寻址，即发送端计算机必须能够定位到接收数据的计算机，接收计算机必须能够识别自己要接收的数据。
* 将数据路由到目的计算机所在的子网，即使源子网和目的子网分处不同的物理网络。
* 执行错误控制、流量控制和确认：对可靠的通信而言，发送和接收计算机必须能够发现并纠正传输错误，并控制数据流。
* 从应用程序接收数据并传输到网络。
* 从网络接收数据并传输到应用程序。

### 协议模型

![image-20191221224338605](D:\data\notes\notes\计算机基础\TCPIP\TCP-IP\image-20191221224338605.png)

`TCP/IP`四层模型 : 

* 网络访问层：提供了与物理网络连接的接口。针对传输介质设置数据的格式，根据硬件的物理地址实现数据的寻址，对数据在物理网络中的传递提供错误控制。
* 网际层：提供独立于硬件的逻辑寻址，从而让数据能够在具有不同物理结构的子网之间传递。提供路由功能来降低流量，支持网间的数据传递（术语“网间"（internetwork）指的是多个局域网互相连接而形成的较大的网络，比如大公司里的网络或Internet）。实现物理地址（网络访问层使用的地址）与逻辑地址的转换。
* 传输层：为网络提供了流量控制、错误控制和确认服务。充当网络应用程序的接口。
* 应用层：为网络排错、文件传输、远程控制和Internet 操作提供了应用程序，还支持应用编程接口（API），从而使得针对特定操作系统编写的程序能够访问网络。

OSI模型的7层分别如下所示。
* 物理层：把数据转换为传输介质上的电子流或模拟脉冲，并且监视数据的传输。
* 数据链路层：提供与网络适配器相连的接口，维护子网的逻辑链接。
* 网络层：支持逻辑寻址与路由选择。
* 传输层：为网络提供错误控制和数据流控制。
* 会话层：在计算机的通信应用程序之间建立会话。
* 表示层：把数据转换为标准格式，管理数据加密与压缩。
* 应用层：为应用程序提供网络接口，支持文件传输、通信等功能的网络应用。

![image-20191221230046429](D:\data\notes\notes\计算机基础\TCPIP\TCP-IP\image-20191221230046429.png)



![image-20191221232407027](D:\data\notes\notes\计算机基础\TCPIP\TCP-IP\image-20191221232407027.png)

基本场景如下 : 

1.数据从工作于应用层的协议、网络服务或应用编程接口（API）通过TCP或UDP端口传递到两个传输层协议（TCP或UDP）中的一个。程序可以根据需要通过TCP或UDP访问网络。

2.数据分段传递到网际层，IP协议在此提供逻辑寻址信息，并且把数据封装为数据报。

3.IP数据报进入网络访问层，传递到与物理网络相连接的软件组件。网络访问层创建一个或多个数据帧，从而进入到物理网络。在像以太网这样的局域网系统中，帧可能包含从表格里获得的物理地址信息，而这些表格是由网际层的ARP维护的（ARP是地址解析协议，把IP地址转换为物理地址）。

4.数据帧被转化为比特流，通过网络介质进行传输。

### 1.网络访问层

网络访问层以上的协议层不必关心硬件设计的问题.`TCP/IP`协议栈的设计保证了与硬件交互相关的细节发生在网络访问层,使得`TCP/IP`能够工作于多种不同的传输介质.

它管理为物理网络准备数据所必需的服务与功能，包括：
* 与计算机网络适配器的连接；
* 根据合适的访问方式调整数据传输；
* 把数据转化为电子流或模拟脉冲的形式，以在传输介质上进行传输；
* 对接收到的数据进行错误检查；
* 给发送的数据添加错误检查信息，从而让接收端计算机能够对数据进行错误检查。

`网络访问层`大致对应OSI模型的`数据链路层`和`物理层`

* 物理层 : 负责把数据转化为适合于传输介质的比特流,也就是物理层管理实际传输的电子或模拟脉冲
* 数据链路层 : 执行两个独立的任务,相应的分为两个子层
  * 介质访问控制(MAC) : 这个子层提供与网络适配器连接的接口。实际上，网络适配器驱动程序通常被称为MAC驱动，而网卡在工厂固化的硬件地址通常被称为MAC地址。
  * 逻辑链路控制(LLC) : 这个子层对经过子网传递的帧进行错误检查，并且管理子网上通信设备之间的链路。

网络访问层包含如下体系 : 

* IEEE802.3（以太网）：在大多数办公室和家庭使用的基于线缆的网络。
* IEEE802.11（无线网络）：在办公室、家庭和咖啡厅使用的无线网络技术。
* IEEE802.16（WiMAX）：用于移动通信长距离无线连接的技术。
* 点到点协议（PPP）：Modem通过电话线进行连接的技术。

#### 以太网

以太网使用称为`载波侦听多路访问/冲突检测(CSMA/CD)`的方法,来判断计算机何时可以把数据发送到访问介质

当以太网软件从网际层接收到数据报之后，执行以下操作。

* 1.根据需要把网际层的数据分解为较小的块，以符合以太网帧数据段的要求。以太网帧的整体大小必须在64字节与1518字节之间（不包含前导码）。有些系统支持更大的帧，最大可以到9000字节。这种大型帧能够改善效率，但存在着兼容性的问题，而且并没有得到广泛支持。
* 2.把数据块打包成帧。每一帧都包含数据及其他信息，这些信息是以太网网络适配器处理帧所需要的。IEEE 802.3以太网帧包含以下内容。
  * 前导码：表示帧起始的一系列比特（一共8字节，最后一个字节是帧起始符）。
  * 目标地址：接收帧的网络适配器的6字节（48比特）物理地址。
  * 源地址：发送帧的网络适配器的6字节（48比特）物理地址。
  * 可选的VLAN标记：这个可选的16比特字段在802.1q标准中有讲解，其目的是允许多个虚拟LAN通过同一个网络交换机运行。
  * 长度：两个字节，表示数据段的长度。
  * 数据：帧中传输的数据。
  * 帧校验序列（FCS）：帧的4字节（32比特）校验和。FCS是检验数据传输的常见方式。发送方计算帧的循环冗余码校验（CRC）值，把这个值写到帧里。接收方计算机重新计算CRC，与FCS字段的值进行比较，如果两个值不相同，就表示传输过程中发生了数据丢失或改变，这时就需要重新传输这一帧。
* 3.把数据帧传递给对应于OSI模型物理层的底层组件，后者把帧转换为比特流，并且通过传输介质发送出去。

以太网上其他网络适配器接收到这个帧，检查其中的目的地址。如果目的地址与网络适配器的地址相匹配，适配器软件就会处理接收到的帧，把数据传递给协议栈中较高的层。

### 2.网际层

![image-20191222211803770](D:\data\notes\notes\计算机基础\TCPIP\TCP-IP\image-20191222211803770.png)

路由式通信中,TCP/IP软件发送数据的策略为 : 

* 1.如果目的地址与源地址在同一个网段，源计算机就把数据包直接发送给目的计算机。IP地址被ARP解析为物理地址，数据被直接发送到目的网络适配器。

* 2.如果目的地址与源地址不在一个网段上，就执行如下过程。

  * a）直接将数据报发送到网关。网关是位于局域网网段上的一个设备，能够把数据报转发到其他网段。网关地址被ARP解析为物理地址，数据被发送到网关的网络适配器。
  * b）数据报通过网关被路由到较高级别的网段，再次重复上述过程。如果目的地址在这个新网段里，数据就被发送到目的，否则数据报就会被发送到另一个网关。
  * C）数据报经过一系列网关被转发到目的网段，目的IP地址被ARP解析为物理地址，数据被发送到目的网络适配器。

  

#### 网际层协议功能 : 

  * 识别网络中所有的计算机；
  * 提供一种方式来判断何时需要通过网关来传递消息；
  * 提供一种与硬件无关的方式来识别目的网段，从而让数据报能够高效率地经过路由器到达正确的网段；
  * 提供一种方式把目标计算机的逻辑IP地址转化为物理地址，让数据能够传输给目的计算机的网络适配器。

#### 网际协议(IP)

  IP地址分为两个部分 : 

* 网络ID
* 主机ID

##### 子网划分

##### IP报头字段

##### IP寻址

##### 特殊IP地址

全0的主机ID表示网络本身,例如192.152.0.0指网络ID为192.152的B类网络

全1的主机ID表示广播,广播是向网络中全部主机发送的消息,Ip地址为192.152.255.255就是网络ID为192.162的B类网络的广播地址

地址255.255.255.255 也可以用于网络上的广播

以十进制值127开头的地址是环回地址。目的地址为环回地址的消息是由本地TCP/IP软件发送的，其目的在于测试TCP/IP软件是否工作正常。ping功能的使用。通常使用的环回地址是127.0.0.1。

##### 地址解析协议(ARP)

##### 逆向ARP(RARP)

##### Internet 控制消息协议(ICMP)

ICMP消息 : 

* Echo Request（回显请求）和Echo Reply（回显应答）：ICMP经常被用于测试，比如测试连接的ping命令实际上就是在使用ICMP。ping向某个IP地址发送一个数据报，并且要求目的计算机在响应中返回所发送的数据。ping实际使用的命令是ICMP的Echo Request和Echo Reply。
* Source Quench（源抑制）：如果一台高速计算机向远程计算机发送大量数据，可能会使路由器产生过载。这时路由器可以利用ICMP向源IP发送Source Quench消息，让它降低发送数据的速度。如果有必要，还可以向源IP发送额外的源抑制消息。
* Destination Unreachable（目的不可到达）：如果路由器收到一个不能传递的数据报，ICMP就会向源IP返回一个Destination Unreachable消息。路由器不能传递消息的原因之一是网络由于设备故障或维修而关闭。
* Time Exceeded（超时）：当数据报由于TTL为0而被抛弃时，ICMP就会向源IP发送这个消息。这表示对于当前TTL值来说，到达目标需要经过太多的路由器；或者是说明路由表出了问题，导致数据报在同一台路由器上连续循环。
* 当数据报无限循环且永远不能到达目的地时，就会发生路由环路。假设3台路由器分别位于洛杉矶、旧金山和丹佛。洛杉矶的路由器向旧金山的路由器发送一个数据报，后者又发送给丹佛，丹佛又发送给洛杉矶。这样一来，数据报就被陷在其中，不断在这3台路由器之间循环，直到TTL为0。路由环路不应该发生，但偶尔也会出现。当网络管理员在路由表里设置了一条静态路由时，有时就可能导致环路路由。
* Fragmentation Needed（需要分段）：如果一个数据报的"Don't Fragment（不可分解）”位被设置为1，而路由器必须要对数据报进行分段才能把它转发到下一台路由器或目的地，这时ICMP就会发送这条消息。

##### 网际层其他协议

* 边界网关协议(BGP)
* 路由信息协议(RIP)
* IPSec协议

##### 子网

子网掩码 : 子网掩码的每一位代表IP地址中的一个位,用1表示Ip地址中属于网络ID或子网ID的位,用0表示IP地址里属于主机ID的位

![image-20191223104351313](D:\data\notes\notes\计算机基础\TCPIP\TCP-IP\image-20191223104351313.png)

### 3.传输层

传输层协议功能 : 

* 为网络应用程序提供接口：也就是为应用程序提供访问网络的途径。设计者希望不仅能够向目的计算机传递数据，还能够向目的计算机上的特定程序传递数据。

* 多路复用/多路分解机制：这里的多路复用表示从不同的应用程序和计算机接收数据，再把数据传递到目的计算机上的接收程序。换句话说，传输层必须能够同时支持多个网络程序和管理传递给网际层的数据流。在接收端，传输层必须能够从网际层接收数据，把它转发到多个程序，这种功能被称为多路分解，它可以让一台计算机同时支持多个网络程序，比如一个Web浏览器、一个E-mail客户端和一个文件共享应用程序。多路复用/多路分解的另一个作用是可以让一个应用程序同时保持与多台计算机的连接。

* 错误检测、流量控制和验证：协议系统需要一种全面机制来确保发送端与接收端之间的数据传输。

  传输层提供了两种到达目标网络的方式，它们都具有支持应用程序所必需的接口和多路复用/多路分解功能，但在质量保证方面所采用的方法有很大不同，如下所示。

  * 传输控制协议（TCP）：TCP提供了完善的错误控制和流量控制，能够确保数据正确传输，它是一个面向连接的协议。
  * 用户数据报协议（UDP）：UDP只提供了非常基本的错误检测，用于不需要TCP精细控制功能的场合，它是一个无连接的协议。

#### 面向连接的协议和面向无连接的协议

* 面向连接的协议：会在通信计算机之间建立并维护一个连接，并且在通信过程中监视连接的状态。换句话说，通过网络传输的每个数据包都会有一个确认，发送端计算机会记录状态信息来确保每个数据包都被正确无误地接收了，并且在需要时会重发数据。当数据传输结束之后，发送端和接收端计算机会以适当方式关闭连接。
* 无连接的协议：以单向方式向目的发送数据报，不承担通知目的计算机关于数据发送的职责。目的计算机接收到数据后也不需要向源计算机返回状态信息。

##### TCP重要特性

* 面向流的处理：TCP以流的方式处理数据。换句话说，TCP可以一个字节一个字节地接收数据，而不是一次接收一个预定义格式的数据块。TCP把接收到的数据组成长度不定的段，再传递到网际层。
* 重新排序：如果数据以错误的顺序到达目的，TCP模块能够对数据重新排序来恢复原始顺序。
* 流量控制：TCP的流量控制特性能够确保数据传输不会超过目的计算机接收数据的能力。由于现实世界里会有各种不同的应用环境，处理器速度和缓存区大小的差别也可能很大，所以这种流控制能力是非常重要的。
* 优先级与安全：国防部对TCP的规范要求可以为TCP连接设置可选的安全级别和优先级，但很多TCP实现并没有提供这些安全和优先级特性。
* 适当的关闭：TCP像重视建立连接一样重视关闭连接的工作，以确保在连接被关闭之前，所有的数据段都被发送和接收了。

#### 端口和套接字

传输层充当了网络应用程序与网络之间的接口，并且能够把网络数据传递给特定的应用程序。在TCP/IP系统中，应用程序可以使用端口号通过TCP或UDP指定数据目的地。端口是一个预定义的内部地址，充当从应用程序到传输层或是从传输层到应用程序之间的通路

#### 多路复用与多路分解

#### 防火墙和端口

#### 三次握手

* seq：sequence number的缩写，表示所传数据的序号。TCP传输时每一个字节都有一个序号，发送数据时会将数据的第一个序号发送给对方，接收方会按序号检查是否接收完整了，如果没接收完整就需要重新传送，这样就可以保证数据的完整性
* ack：acknoledgement number的缩写，表示确认号。接收端用它来给发送端反馈已经成功接收到的数据信息的，它的值为希望接收的下一个数据包起始序号，也就是ack值所代表的序号前面数据已经成功接收到了。
* ACK：确认位，只有ACK=1的时候ack才起作用。正常通信时ACK为1，第一次发起请求时因为没有需要确认接收的数据所以ACK为0。
* SYN：同步位，用于在建立连接时同步序号。刚开始建立连接时并没有历史接收的数据，所以ack也就没办法设置，这时按照正常的机制就无法运行了，SYN的作用就是来解决这个问题的，当接收端接收到SYN=1的报文时就会直接将ack设置为接收到的seq+1的值，注意这里的值并不是校验后设置的，而是根据SYN直接设置的，这样正常的机制就可以运行了，所以SYN叫同步位。需要注意的是，SYN会在前两次握手时都为1，这是因为通信的双方的ack都需要设置一个初始值。
* FIN：终止位，用来在数据传输完毕后释放连接。

![image-20191223152946218](D:\data\notes\notes\计算机基础\TCPIP\TCP-IP\image-20191223152946218.png)

* 第一次握手(SYN=1,ACK=0,序列号=x)

  计算机A发送一个SYN标识位置1的包,表示打开连接,以及ACK=0表示连接请求,和初始序列号x.

  计算机A进入`SYN_SEND`状态

* 第二次握手(SYN=1,ACK=1,序列号=Y,确认号=X+1)

  计算机B发回应答.SYN=1,ACK=1,自己的初始序列号Y,和确认序列号设置为计算机A的序列号+1,即X+1

  服务器进入`SYN-RCVD`状态

* 第三次握手(SYN=0,ACK=1,序列号=X+1,确认号=Y+1)

  计算机A再次发送确认包,SYN=0,ACK=1,并且在确认序列号中把计算B发的序列号+1,即Y+1

  计算机A发送之后进入`ESTABLISHED`状态,计算机B接收到这个包,也进入`ESTABLISHED`状态,至此TCP握手结束

#### 四次挥手(释放连接)

![image-20191223161649637](D:\data\notes\notes\计算机基础\TCPIP\TCP-IP\image-20191223161649637.png)

当计算机A没有东西要发送时就要释放A这边的连接，A会发送一个报文（没有数据），其中FIN设置为1，计算机B收到后会给应用程序一个信，这时A那边的连接已经关闭，即A不再发送信息（但仍可接收信息）。A收到B的确认后进入等待状态，等待B请求释放连接，B数据发送完成后就向A请求连接释放，也是用FIN=1表示，并且用ack=u+1，A收到后回复一个确认信息，并进入TIMEWAIT状态，等待2MSL时间。

### 4.应用层

`TCP/IP`的`应用层`对应`OSI模型`的`应用层`,`表示层`,`会话层`

对OSl模型相应层的介绍如下。

* 应用层：OSI的应用层（不要与TCP/IP的应用层混淆）包含的组件为用户应用程序提供服务并支持网络访问。

* 表示层：表示层把数据转化为与平台无关的格式，并处理加密和数据压缩。
* 会话层：负责管理联网计算机上应用程序之间的通信，提供了一些传输层不具备、与连接相关的功能，比如名称识别和安全。

## 协议簇(protocol suite)

`TCP/IP`及其相关的协议构成了一套在`TCP/IP`网络中如何处理、传输和接收数据的完整系统，相关协议的系统，被称为协议簇



### 逻辑编址

网路适配器有一个唯一的物理地址,称为MAC地址

计算机的逻辑地址称为IP地址,包括 : 

* 一个识别网络的`网络ID数值`
* 一个识别网络中子网的子`网ID数值`
* 一个识别子网中计算机的`主机ID数值`



在`TCP/IP`中,逻辑地址与具体硬件的物理地址之间的转换是使用地址解析协议(Adress Resolution Protocol,ARP)和逆向地址解析协议(Reverse ARP, RARP)实现的

### 路由选择

路由器是一种特殊的设备，能够读取逻辑地址信息，并将数据通过网络直接传送到它的目的地。

局域网（LAN）：供单个办公室、组织或家庭使用的小型网络，通常只占据一个地理位置。

网关：连接LAN到大型网络的路由器。

### 错误控制和流量控制

### 应用支持

这个通过系统的逻辑通道实现从网络到应用程序的接口被称为端口。每个端口有一个用于识别该端口的数字。

## 网络地址转换(NAT)

## 域名或域名系统(Domain Name System, DNS)

域名：通过TCP/IP的DNS域名服务系统，与IP地址相关联的名字。

域名到IP地址的映射称为名称解析

域名服务器存储了用于显示域名和IP地址转换方式的表