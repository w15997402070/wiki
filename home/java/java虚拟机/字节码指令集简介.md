# java字节码指令集简介

Java虚拟机的指令由一个字节长度的、代表着某种特定操作含义的**操作码（opcode）**以及跟随其后的零至多个代表此操作所需参数的**操作数（operand）**所构成。

操作数的数量以及长度取决于操作码，如果一个操作数的长度超过了一个字节，那么它将会以big-endian顺序存储，即高位在前的字节序。例如，如果要将一个16位长度的无符号整数使用两个无符号字节存储起来（将它们命名为 byte1 和 byte2 ），那这个16位无符号整数的值就是：`（bytel<<8）| byte2`。

## 数据类型与Java虚拟机

操作码的助记符中都有特殊的字符来表明该指令为哪种数据类型服务:

* `i` : int 类型的数据操作
* `l` : long
* `s` : short
* `b` : byte
* `c` : char
* `f` : float
* `d` : double
* `a` : reference

### java虚拟机指令所支持的数据类型表

用数据类型列所代表的特殊字符替换操作码列的指令模板中的T,就可以得到一个具体的字节码指令.

例如 `int(i) 替换 Tconst -> iconst` 

如果表中指令模板与数据类型两列共同确定的单元格为空,则说明虚拟机不支持对这种数据类型执行这项操作.

例如 `load 指令有操作 int 类型的 iload,但没有操作 byte 类型的同类指令`

| 操作码     | byte(b) | short(s) | int(i)    | long(l) | float(f) | double(d) | char(c) | reference(a) |
| ---------- | ------- | -------- | --------- | ------- | -------- | --------- | ------- | ------------ |
| Tipush     | bipush  | sipush   |           |         |          |           |         |              |
| Tconst     |         |          | iconst    | lconst  | fconst   | dconst    |         | aconst       |
| Tload      |         |          | iload     | lload   | fload    | dload     |         | aload        |
| Tstore     |         |          | istore    | lstore  | fstore   | dstore    |         | astore       |
| Tinc       |         |          | iinc      |         |          |           |         |              |
| Taload     | baload  | saload   | iaload    | laload  | faload   | daload    | caload  | aaload       |
| Tastore    | bastore | sastore  | iastore   | lastore | fastore  | dastore   | castore | aastore      |
| Tadd       |         |          | iadd      | ladd    | fadd     | dadd      |         |              |
| Tsub       |         |          | isub      | lsub    | fsub     | dsub      |         |              |
| Tmul       |         |          | imul      | lmul    | fmul     | dmul      |         |              |
| Tdiv       |         |          | idiv      | ldiv    | fdiv     | ddiv      |         |              |
| Trem       |         |          | irem      | lrem    | frem     | drem      |         |              |
| Tneg       |         |          | ineg      | lneg    | fneg     | dneg      |         |              |
| Tshl       |         |          | ishl      | lshl    |          |           |         |              |
| Tshr       |         |          | ishr      | lshr    |          |           |         |              |
| Tushr      |         |          | iushr     | lushr   |          |           |         |              |
| Tand       |         |          | iand      | land    |          |           |         |              |
| Tor        |         |          | ior       | lor     |          |           |         |              |
| Txor       |         |          | ixor      | lxor    |          |           |         |              |
| i2T        | i2b     | i2s      |           | i2l     | i2f      | i2d       |         |              |
| l2T        |         |          | l2i       |         | l2f      | lsd       |         |              |
| f2T        |         |          | f2i       | f2l     |          |           |         |              |
| d2T        |         |          | d2i       | d2l     | d2f      |           |         |              |
| Tcmp       |         |          |           | lcmp    |          |           |         |              |
| Tcmpl      |         |          |           |         | fcmpl    | dcmpl     |         |              |
| Tcmpg      |         |          |           |         | fcmpg    | dcmpg     |         |              |
| if_TcmpOpP |         |          | if_icmpOP |         |          |           |         | if_acmpOP    |
| Treturn    |         |          | ireturn   | lreturn | freturn  | dreturn   |         | areturn      |

## Java虚拟机中实际类型与运算类型

| 实际类型      | 运算类型      | 分类 |
| ------------- | ------------- | ---- |
| boolean       | int           | 1    |
| byte          | int           | 1    |
| char          | int           | 1    |
| short         | int           | 1    |
| int           | int           | 1    |
| float         | float         | 1    |
| reference     | reference     | 1    |
| returnAddress | returnAddress | 1    |
| long          | long          | 2    |
| double        | double        | 2    |

指令加载:

`iconst` : 指令将常量压入栈中 , 加载 `[-1,5]` 的值 `int i = 2`,字节码就是 `iconst_2`

`bipush` :  指令将常量压入栈中, 加载 `[ -`128`,127 ]` 的值,`int i = 27` ,字节码就是 `bipush  27`

`sipush` :  指令将常量压入栈中 ,加载  ` [-32768,32767]`  的值,`int i = 129 `,字节码就是 `sipush  129`

ldc :  指令将常量压入栈中  [-2147483648,2147483647] , ldc指令是从常量池中获取值的 

### 指令

![](D:\data\notes\notes\java\java虚拟机\字节码指令集简介.assets\指令-1573804405070.png)

### 类型转换

在将一个浮点类型数值窄化转换为整数类型T（其中T限于int或1ong类型）时，将遵循以下转换规则：

* 如果浮点类型数值是 NaN，那转换结果就是 int 或 long 类型的0。

* 否则，如果浮点类型数值不是无穷，那么浮点类型数值就依照IEEE754标准的向零舍入模式取整，获得整型数值V，这时可能有两种情况：

  * 如果 T 是 long 类型，并且转换结果在 long 类型的表示范围之内，那就转换为 long 类型数值V。

  * 如果T是 int 类型，并且转换结果在 int 类型的表示范围之内，那就转换为 int 类型数值V。

* 否则：
    * 如果转换结果V的值太小（包括绝对值很大的负数以及负无穷大的情况），无法使用T类型表示，那转换结果取 in t或 long 类型所能表示的最小数值。
    * 如果转换结果V的值太大（包括很大的正数以及正无穷大的情况），无法使用 T 类型表示，那转换结果取 int 或 long 类型所能表示的最大数值。

## 指令格式

`<index> <opcode> [<operand1> [operand2]...] [<comment>]`

* `<index>` 指令操作码在数组中的下标,也可认为是相对于方法起始处的字节偏移量
* `<opcode>` 指令的操作码助记符号
* `<operandN>`s 是指令的操作数,一条指令可以有0至多个操作数
* `<comment>` 行尾注释

例如 : 

```java
6: ldc           #2                  // int 32768
```

